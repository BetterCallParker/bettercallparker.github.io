<script>
    // PDF.js initialization with improved font configuration
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    pdfjsLib.GlobalWorkerOptions.useWorkerFetch = true;

    // Font and CMAP configuration
    const CMAP_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/cmaps/';
    const FONT_URL = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/standard_fonts/';
    
    // Variables for PDF rendering
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let canvas = document.getElementById('pdf-canvas');
    let ctx = canvas.getContext('2d');
    let scale = 1.5;
    let helperMode = false;
    
    // Field positions for your PDF - UPDATED with your provided coordinates
    // Format: [pageNumber, x, y, width, height]
    let fieldPositions = {
        'fullName': [1, 116, 212, 250, 25],        // Line 1 (Buyer's name)
        'signature': [3, 82, 639, 250, 35],        // Line 108 (Signature)
        'startDate': [1, 340, 438, 120, 25],       // Line 9 (Agreement start date)
        'expirationDate': [1, 111, 466, 120, 25],  // Line 10 (Expiration date)
        'signatureDate': [3, 362, 645, 100, 25],   // Line 108 (Signature date)
        'buyerInitials1': [1, 287, 876, 40, 25],   // Line 27 (Initials)
        'buyerInitials2': [2, 274, 903, 40, 25],   // Line 76 (Initials)
        'buyerInitials3': [3, 261, 295, 40, 25]    // Line 95 (Initials)
    };
    
    // Load the PDF with improved configuration
    function loadPDF() {
        // Use your actual PDF path (make sure this matches your uploaded file name)
        const url = 'buyer-broker-agreement.pdf';
        
        // Configure PDF.js with font loading options
        pdfjsLib.getDocument({
            url: url,
            cMapUrl: CMAP_URL,
            cMapPacked: true,
            standardFontDataUrl: FONT_URL,
            // Silence warnings about missing fonts
            disableFontFace: false,
            // Ignore corruption warnings
            stopAtErrors: false,
        }).promise.then(function(pdf) {
            pdfDoc = pdf;
            document.getElementById('page-count').textContent = pdf.numPages;
            renderPage(pageNum);
        }).catch(function(error) {
            // If PDF fails to load, show a placeholder
            console.error('Error loading PDF:', error);
            ctx.fillStyle = '#f1f1f1';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#333';
            ctx.font = '20px Arial';
            ctx.fillText('PDF preview not available.', 50, 100);
            ctx.font = '16px Arial';
            ctx.fillText('Your information will still be collected.', 50, 130);
        });
    }
    
    // Render the specified page with improved error handling
    function renderPage(num) {
        pageRendering = true;
        
        // Using promise to fetch the page
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({ scale: scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            // Render PDF page into canvas context
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            
            const renderTask = page.render(renderContext);
            
            // Wait for rendering to finish
            renderTask.promise.then(function() {
                pageRendering = false;
                
                if (pageNumPending !== null) {
                    // New page rendering is pending
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
                
                // Update form overlay positions
                updateFormOverlay();
            }).catch(function(renderError) {
                console.warn('Error rendering page:', renderError);
                pageRendering = false;
                
                // Try to continue with pending page if there is one
                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
                
                // Draw fallback content
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#495057';
                ctx.font = '16px Arial';
                ctx.fillText(`Page ${num} rendering issue. You can still continue.`, 50, 100);
                
                // Still update the overlay
                updateFormOverlay();
            });
        }).catch(function(pageError) {
            console.error('Error getting page:', pageError);
            pageRendering = false;
            
            // Try to continue with pending page if there is one
            if (pageNumPending !== null) {
                renderPage(pageNumPending);
                pageNumPending = null;
            }
        });
        
        // Update page numbers
        document.getElementById('page-num').textContent = num;
    }
    
    // Go to previous page
    function previousPage() {
        if (pageNum <= 1) {
            return;
        }
        pageNum--;
        queueRenderPage(pageNum);
    }
    
    // Go to next page
    function nextPage() {
        if (pageNum >= pdfDoc.numPages) {
            return;
        }
        pageNum++;
        queueRenderPage(pageNum);
    }
    
    // Queue page rendering if another page is currently rendering
    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }
    
    // Generate and format dates
    function setupDateFields() {
        // Get current date
        const today = new Date();
        
        // Format today's date as MM/DD/YYYY
        const formattedToday = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                            today.getDate().toString().padStart(2, '0') + '/' + 
                            today.getFullYear();
        
        // Calculate expiration date (2 months from today)
        const expirationDate = new Date(today);
        expirationDate.setMonth(today.getMonth() + 2);
        
        // Format expiration date as MM/DD/YYYY
        const formattedExpiration = (expirationDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                   expirationDate.getDate().toString().padStart(2, '0') + '/' + 
                                   expirationDate.getFullYear();
        
        // Add the dates to the overlay
        updateFormField('startDate', formattedToday);
        updateFormField('expirationDate', formattedExpiration);
        updateFormField('signatureDate', formattedToday);
        
        // Store the dates for form submission
        document.getElementById('hiddenStartDate').value = formattedToday;
        document.getElementById('hiddenExpirationDate').value = formattedExpiration;
    }
    
    // Initialize signature pad
    function initSignaturePad() {
        const signatureCanvas = document.getElementById('signature-pad');
        const signatureCtx = signatureCanvas.getContext('2d');
        let isDrawing = false;
        
        // Set canvas dimensions
        signatureCanvas.width = signatureCanvas.offsetWidth;
        signatureCanvas.height = signatureCanvas.offsetHeight;
        
        // Fill with white background
        signatureCtx.fillStyle = 'white';
        signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        
        // Drawing events
        signatureCanvas.addEventListener('mousedown', startDrawing);
        signatureCanvas.addEventListener('mousemove', draw);
        signatureCanvas.addEventListener('mouseup', stopDrawing);
        signatureCanvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events
        signatureCanvas.addEventListener('touchstart', startDrawingTouch);
        signatureCanvas.addEventListener('touchmove', drawTouch);
        signatureCanvas.addEventListener('touchend', stopDrawing);
        
        function startDrawing(e) {
            isDrawing = true;
            signatureCtx.beginPath();
            signatureCtx.moveTo(e.offsetX, e.offsetY);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.strokeStyle = 'black';
            
            signatureCtx.lineTo(e.offsetX, e.offsetY);
            signatureCtx.stroke();
        }
        
        function startDrawingTouch(e) {
            e.preventDefault();
            
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const offsetX = touch.clientX - rect.left;
            const offsetY = touch.clientY - rect.top;
            
            isDrawing = true;
            signatureCtx.beginPath();
            signatureCtx.moveTo(offsetX, offsetY);
        }
        
        function drawTouch(e) {
            e.preventDefault();
            
            if (!isDrawing) return;
            
            const rect = signatureCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const offsetX = touch.clientX - rect.left;
            const offsetY = touch.clientY - rect.top;
            
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.strokeStyle = 'black';
            
            signatureCtx.lineTo(offsetX, offsetY);
            signatureCtx.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        // Clear signature
        document.getElementById('clear-signature').addEventListener('click', function() {
            signatureCtx.fillStyle = 'white';
            signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            updateFormField('signature', ''); // Clear signature from overlay
            document.getElementById('signature-data').value = ''; // Clear hidden input
        });
        
        // Accept signature
        document.getElementById('accept-signature').addEventListener('click', function() {
            const signatureData = signatureCanvas.toDataURL();
            updateFormField('signature', signatureData);
            document.getElementById('signature-data').value = signatureData; // Store in hidden input
        });
    }
    
    // Create form overlay elements
    function createFormOverlay() {
        const formOverlay = document.getElementById('form-overlay');
        
        // Create overlay elements for each form field
        for (const field in fieldPositions) {
            const element = document.createElement('div');
            element.id = `overlay-${field}`;
            element.className = 'overlay-field';
            formOverlay.appendChild(element);
        }
    }
    
    // Update form overlay with current values
    function updateFormOverlay() {
        // Only show overlays for the current page
        const currentPage = pageNum;
        
        for (const field in fieldPositions) {
            const overlayElement = document.getElementById(`overlay-${field}`);
            const fieldPosition = fieldPositions[field];
            
            // Check if field is on current page
            if (fieldPosition[0] === currentPage) {
                const [_, x, y, width, height] = fieldPosition;
                
                // Position the overlay element
                overlayElement.style.display = 'block';
                overlayElement.style.left = `${x}px`;
                overlayElement.style.top = `${y}px`;
                overlayElement.style.width = `${width}px`;
                overlayElement.style.height = `${height}px`;
            } else {
                // Hide overlay elements not on current page
                overlayElement.style.display = 'none';
            }
        }
    }
    
    // Update a specific form field on the overlay
    function updateFormField(field, value) {
        const overlayElement = document.getElementById(`overlay-${field}`);
        
        if (!overlayElement) return;
        
        if (field === 'signature') {
            // For signature, create an image
            overlayElement.innerHTML = '';
            if (value) {
                const img = document.createElement('img');
                img.src = value;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'contain'; // Prevent stretching
                overlayElement.appendChild(img);
            }
        } else {
            // For text fields
            overlayElement.textContent = value;
        }
    }
    
    // Propagate initials to all required spots
    function propagateInitials(initials) {
        updateFormField('buyerInitials1', initials);
        updateFormField('buyerInitials2', initials);
        updateFormField('buyerInitials3', initials);
    }
    
    // Function to generate the completed PDF with improved error handling
    async function generateCompletedPDF() {
        try {
            // PDF template URL - make sure this points to your PDF
            const pdfUrl = 'buyer-broker-agreement.pdf';
            
            // Fetch the PDF template
            const pdfBytes = await fetch(pdfUrl)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! Status: ${res.status}`);
                    }
                    return res.arrayBuffer();
                })
                .catch(error => {
                    console.error('Error fetching PDF template:', error);
                    throw new Error('Could not load the PDF template. Please try again later.');
                });
            
            // Load the PDF document using PDF-LIB (with encryption handling)
            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { 
                ignoreEncryption: true 
            });
            
            // Get form values
            const fullName = document.getElementById('fullName').value;
            const initials = document.getElementById('initials').value;
            const startDate = document.getElementById('hiddenStartDate').value;
            const expirationDate = document.getElementById('hiddenExpirationDate').value;
            const signatureData = document.getElementById('signature-data').value;
            
            // Get all pages
            const pages = pdfDoc.getPages();
            
            // Add a standard font
            const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            
            // Page 1
            const page1 = pages[0];
            
            // Add full name
            page1.drawText(fullName, {
                x: 116,
                y: page1.getHeight()- 212,
                size: 12,
                font: helveticaFont
            });
            
            // Add start date
            page1.drawText(startDate, {
                x: 340,
                y: page1.getHeight() - 438,
                size: 12,
                font: helveticaFont
            });
            
            // Add expiration date
            page1.drawText(expirationDate, {
                x: 111,
                y: page1.getHeight() - 466,
                size: 12,
                font: helveticaFont
            });
            
            // Add initials on page 1
            page1.drawText(initials, {
                x: 287,
                y: page1.getHeight() - 876,
                size: 12,
                font: helveticaFont
            });
            
            // Page 2
            const page2 = pages[1];
            
            // Add initials on page 2
            page2.drawText(initials, {
                x: 274,
                y: page2.getHeight() - 903,
                size: 12,
                font: helveticaFont
            });
            
            // Page 3
            const page3 = pages[2];
            
            // Add initials on page 3
            page3.drawText(initials, {
                x: 261,
                y: page3.getHeight() - 295,
                size: 12,
                font: helveticaFont
            });
            
            // Add signature date on page 3
            page3.drawText(startDate, {
                x: 362,
                y: page3.getHeight() - 645,
                size: 12,
                font: helveticaFont
            });
            
            // Add signature
            if (signatureData) {
                try {
                    // Convert signature data URL to image
                    const signatureImage = await pdfDoc.embedPng(signatureData);
                    
                    // Add signature to page 3
                    page3.drawImage(signatureImage, {
                        x: 82,
                        y: page3.getHeight() - 639 - 35, // Adjust based on your PDF
                        width: 250,
                        height: 35
                    });
                } catch (signatureError) {
                    console.error('Error embedding signature:', signatureError);
                    // Continue without signature if there's an error
                }
            }
            
            // Save the PDF
            const modifiedPdfBytes = await pdfDoc.save();
            return modifiedPdfBytes;
        } catch (error) {
            console.error('Error generating PDF:', error);
            throw error;
        }
    }
    
    // Initialize everything when the document is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize PDF.js
        loadPDF();
        
        // Initialize the signature pad
        initSignaturePad();
        
        // Create form overlay
        createFormOverlay();
        
        // Set up auto-dates
        setupDateFields();
        
        // Add event listeners for page navigation
        document.getElementById('prev-page').addEventListener('click', previousPage);
        document.getElementById('next-page').addEventListener('click', nextPage);
        
        // Listen for initials input to propagate to all spots
        const initialsField = document.getElementById('initials');
        if (initialsField) {
            initialsField.addEventListener('input', function() {
                propagateInitials(this.value);
            });
        }
        
        // Listen for input changes to update the form overlay
        const formInputs = document.querySelectorAll('#agreement-form input[type="text"]');
        formInputs.forEach(input => {
            input.addEventListener('input', function() {
                if (this.id !== 'initials') { // Skip initials field as it's handled separately
                    updateFormField(this.id, this.value);
                }
            });
        });
        
        // Handle form submission with PDF generation
        document.getElementById('agreement-form').addEventListener('submit', async function(e) {
            // Prevent default form submission to validate first
            e.preventDefault();
            
            // Better validation with specific error messages
            let validationMessage = '';
            
            if (!document.getElementById('fullName').value) {
                validationMessage += "• Please enter your full name\n";
            }
            
            if (!document.getElementById('initials').value) {
                validationMessage += "• Please enter your initials\n";
            }
            
            if (!document.getElementById('read').checked) {
                validationMessage += "• Please confirm you've read the agreement\n";
            }
            
            if (!document.getElementById('terms').checked) {
                validationMessage += "• Please agree to the terms\n";
            }
            
            if (!document.getElementById('otherAgent').checked) {
                validationMessage += "• Please confirm you're not working with another agent\n";
            }
            
            // Check if signature exists and is valid
            const signatureCanvas = document.getElementById('signature-pad');
            const signatureData = signatureCanvas.toDataURL();
            document.getElementById('signature-data').value = signatureData;
            
            // A valid signature will have more data than an empty canvas
            const isEmptySignature = signatureData.length < 5000;
            
            if (isEmptySignature) {
                validationMessage += "• Please sign the agreement\n";
            }
            
            // If there are validation errors, show them and stop form submission
            if (validationMessage) {
                alert("Please complete the following:\n" + validationMessage);
                return false;
            }
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerText = "Submitting...";
            
            try {
                // Generate PDF
                const pdfBytes = await generateCompletedPDF();
                
                // Create a Blob from the PDF bytes
                const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // Create a File object from the Blob
                const fileName = `BuyerBrokerAgreement_${document.getElementById('fullName').value.replace(/\s+/g, '_')}.pdf`;
                const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });
                
                // Create FormData for submission
                const formData = new FormData();
                
                // Add form fields to FormData
                const formElements = Array.from(this.elements);
                formElements.forEach(element => {
                    if (element.name && element.name !== 'signature') {
                        if (element.type === 'checkbox') {
                            formData.append(element.name, element.checked);
                        } else {
                            formData.append(element.name, element.value);
                        }
                    }
                });
                
                // Add the PDF file as an attachment
                formData.append('agreement_pdf', pdfFile);
                
                // Submit the form to FormSubmit.co
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok || response.status === 0) { // FormSubmit sometimes returns status 0
                    // Download the PDF for the user
                    const downloadUrl = URL.createObjectURL(pdfBlob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = downloadUrl;
                    downloadLink.download = fileName;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(downloadUrl);
                    
                    // Show success message
                    this.reset();
                    submitButton.style.display = 'none';
                    document.getElementById('thank-you-message').style.display = 'block';
                } else {
                    throw new Error('Form submission failed');
                }
            } catch (error) {
                console.error('Error processing form:', error);
                alert('There was a problem with your submission. Please try again.');
                
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.innerText = "Submit Signed Agreement";
            }
        });
    });
    
    // Handle window resize
    window.addEventListener('resize', function() {
        const signatureCanvas = document.getElementById('signature-pad');
        if (signatureCanvas) {
            // Remember the old content
            const oldContent = signatureCanvas.toDataURL();
            
            // Resize canvas
            signatureCanvas.width = signatureCanvas.offsetWidth;
            signatureCanvas.height = signatureCanvas.offsetHeight;
            
            // Redraw old content
            const ctx = signatureCanvas.getContext('2d');
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, signatureCanvas.width, signatureCanvas.height);
            };
            img.src = oldContent;
        }
    });
    
    // Check for success parameter in URL (for FormSubmit.co redirect)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
        document.getElementById('thank-you-message').style.display = 'block';
        document.querySelector('.submit-btn').style.display = 'none';
    }
</script>
