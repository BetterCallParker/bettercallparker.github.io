<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Buyer Touring Agreement – Parkers Easy Touring Docs</title>

<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

<!-- PDF engines -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<style>
  :root{
    /* Breeze-y minimal palette */
    --brand:#286fde;         /* primary blue */
    --ink:#1f2a37;           /* text */
    --muted:#6b7280;         /* muted text */
    --line:#e5e7eb;          /* borders */
    --bg:#f7f9fc;            /* page bg */
    --card:#ffffff;          /* cards */
    --ok:#10b981;            /* success */
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
    color:var(--ink);
    background:var(--bg);
    line-height:1.55;
  }

  /* Top Bar */
  .topbar{
    background:#fff;
    box-shadow:0 1px 0 var(--line);
    padding:12px 16px;
    display:flex; align-items:center; gap:10px;
    position:sticky; top:0; z-index:30;
  }
  .logo{
    font-weight:800; color:var(--brand); letter-spacing:.2px;
    display:flex; align-items:center; gap:8px;
  }
  .logo i{font-size:18px}
  .crumb{
    margin-left:auto; font-size:.9rem; color:var(--muted);
  }

  /* Stepper */
  .stepper{
    display:flex; gap:8px; padding:10px 16px 0; margin-bottom:6px;
  }
  .dot{height:8px;width:8px;border-radius:999px;background:#cbd5e1;transition:all .25s}
  .dot.active{background:var(--brand); transform:scale(1.2)}
  .dot.done{background:#60a5fa}

  /* Container & Cards */
  .container{max-width:720px;margin:0 auto;padding:12px 16px 24px}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:16px;
    box-shadow:0 8px 20px rgba(2,6,23,.05);
    overflow:hidden;
  }
  .card-header{
    padding:18px 16px; border-bottom:1px solid var(--line); background:#fff;
  }
  .card-title{margin:0;font-size:1.15rem}
  .card-body{padding:16px}
  .section{margin:14px 0}
  .section h3{margin:.2rem 0 .5rem;font-size:1rem}
  .notice{
    background:#eef2ff;border:1px solid #dbeafe;color:#1e3a8a;
    padding:12px;border-radius:12px;font-size:.95rem
  }
  .promise{
    background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;
    padding:12px;border-radius:12px;font-size:.95rem
  }
  .list{margin:8px 0 0 18px}
  .list li{margin:.25rem 0}

  /* Buttons */
  .btn{
    appearance:none;border:none;border-radius:999px;padding:12px 16px;
    font-weight:800;color:#fff;background:var(--brand);
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    cursor:pointer;width:100%;
  }
  .btn.secondary{background:#64748b}
  .actions{padding:14px 16px;border-top:1px solid var(--line);background:#fff}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* Step container */
  .step{display:none;animation:fade .18s ease}
  .step.active{display:block}
  @keyframes fade {from{opacity:.6;transform:translateY(6px)} to{opacity:1;transform:none}}

  /* Inputs */
  label{font-weight:700;display:block;margin:.35rem 0}
  input[type="text"]{
    width:100%;padding:.9rem;border:2px solid var(--line);border-radius:12px;background:#fff;
    font-size:1rem;
  }
  input[type="text"]:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
  .checkbox{
    display:flex;gap:.6rem;align-items:flex-start;background:#f8fafc;border:1px solid var(--line);
    border-radius:12px;padding:.8rem;margin-top:.5rem
  }
  .muted{color:var(--muted);font-size:.93rem}

  /* Signature pad */
  .sig-wrap{border:2px dashed var(--line);border-radius:12px;padding:.8rem;background:#f8fafc}
  #signature-pad{width:100%;height:200px;background:#fff;border:1px solid var(--line);border-radius:8px;touch-action:none}
  .row{display:flex;gap:10px;flex-wrap:wrap}

  /* Digital Reader */
  .digital{max-height:66vh;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
  .digital .page{padding:14px;border-bottom:1px dashed var(--line)}
  .digital .page:last-child{border-bottom:none}
  .chip{display:inline-block;background:#eef2ff;color:#3730a3;font-weight:800;border-radius:999px;padding:.14rem .6rem;margin-bottom:.45rem;font-size:.85rem}
  .jump{margin-top:10px}

  /* Footer */
  footer{color:var(--muted);text-align:center;font-size:.92rem;margin:16px 0 28px}
</style>
</head>
<body>

<!-- Top -->
<div class="topbar">
  <div class="logo"><i class="fa-solid fa-wind"></i> Parkers Easy Touring Form</div>
  <div class="crumb" id="crumb">Step 1 of 3</div>
</div>
<div class="stepper" aria-hidden="true">
  <div class="dot active" id="dot1"></div>
  <div class="dot" id="dot2"></div>
  <div class="dot" id="dot3"></div>
</div>

<main class="container">

<!-- STEP 1: Intro -->
<section id="step1" class="step active">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Welcome! Before we tour</h2>
      </div>
  
      <div class="card-body">
        <!-- Top notice -->
        <div class="notice section">
          <p><strong>All REALTORS®</strong> are required to have this agreement signed prior to showing homes.</p>
          <p>
            This is a requirement of the
            <a href="https://www.nar.realtor/competition-in-real-estate" target="_blank" rel="noopener">
              National Association of REALTORS® settlement
            </a>
            effective <strong>August 17, 2024</strong>.
          </p>

        </div>
  
        <!-- $1 Promise -->
        <div class="promise section">
          <h3 style="margin:.1rem 0 .4rem">My $1 Promise</h3>
          <p>
            <p>
                This Buyer Broker Touring Agreement to Show Property lets me show you homes.
                I’ll negotiate seller paid commission and if I can’t, you pay only <strong>$1</strong>.
              </p>
          </p>
        </div>

      <!-- Bottom alert + Next button -->
      <div class="actions" style="display:flex;flex-direction:column;gap:10px">
        <div class="section" 
             style="background:#fee2e2;border:1px solid #ef4444;color:#991b1b;
                    padding:12px;border-radius:12px;font-size:.95rem;">
          <strong>Heads up:</strong> If you’re currently working with another real estate agent, 
          please tell me before we proceed.
        </div>
        <button class="btn" id="next1">Next</button>
      </div>
    </div>
  </section>
  
  

  <!-- STEP 2: Digital Agreement Reader -->
  <section id="step2" class="step">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Read the Agreement</h2>
      </div>
      <div class="card-body">
        <div id="digital-view" class="digital" aria-live="polite" aria-busy="true">
          <!-- Injected pages -->
        </div>
        <button class="btn secondary jump" id="jumpBottom" type="button">
          Jump to bottom <i class="fa-solid fa-angles-down"></i>
        </button>

        <div class="checkbox">
          <input id="confirm-read" type="checkbox" disabled />
          <label for="confirm-read">I have read and understand the Buyer Broker Touring Agreement.</label>
        </div>
        <div class="muted" style="margin-top:.4rem">
          Prefer the original file? <a href="./assets/Buyer Agreement to Show Property.pdf" download>Download PDF</a>
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="back2" type="button">Back</button>
        <div style="height:10px;width:10px;display:inline-block"></div>
        <button class="btn" id="next2" disabled>Continue</button>
      </div>
    </div>
  </section>

  <!-- STEP 3: Name / Initials / Signature / Submit -->
  <section id="step3" class="step">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Sign & Submit</h2>
      </div>
      <div class="card-body">
        <form id="agreement-form" action="https://formsubmit.co/AaronParkerRealty@gmail.com" method="POST">
          <!-- FormSubmit config -->
          <input type="hidden" name="_subject" value="New Buyer Broker Agreement">
          <input type="hidden" name="_captcha" value="false">
          <input type="hidden" name="_template" value="table">
          <input type="hidden" name="_next" value="thank-you.html">

          <!-- Hidden meta -->
          <input type="hidden" id="hiddenStartDate" name="startDate">
          <input type="hidden" id="hiddenExpirationDate" name="expirationDate">
          <input type="hidden" id="signature-data" name="signature">

          <label for="fullName">Full Legal Name *</label>
          <input id="fullName" name="fullName" type="text" required placeholder="Your full legal name"/>

          <label for="initials" style="margin-top:.6rem">Your Initials *</label>
          <input id="initials" name="initials" type="text" maxlength="10" required placeholder="e.g., A.P."/>

          <div class="sig-wrap" style="margin-top:.9rem">
            <label for="signature-pad"><i class="fa-solid fa-pen-nib"></i> Sign Here *</label>
            <canvas id="signature-pad"></canvas>
            <div class="row" style="margin-top:.6rem">
              <button type="button" id="clear-signature" class="btn secondary"><i class="fa-solid fa-eraser"></i> Clear</button>
              <button type="button" id="accept-signature" class="btn" style="background:var(--ok)"><i class="fa-solid fa-check"></i> Accept</button>
            </div>
            <div class="muted" style="margin-top:.4rem">Scroll down below to submit</div>
          </div>

          <div class="actions" style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn secondary" id="back3" type="button">Back</button>
            <button class="btn" type="submit" id="submit-btn">
              <i class="fa-solid fa-paper-plane"></i> Submit Signed Agreement
            </button>
          </div>

          <!-- Thank you inline (shown after submit) -->
          <div id="thank-you" style="display:none;margin-top:12px;background:#ecfdf5;border:1px solid #86efac;color:#065f46;border-radius:12px;padding:12px;text-align:center">
            <b>Thank you!</b> Your signed agreement was sent. Redirecting in <span id="countdown">10</span>…
          </div>
        </form>
      </div>
    </div>
  </section>

</main>

<footer>
  BetterCallParker • (520) 595-6533 • AaronParkerRealty@gmail.com
</footer>

<script>
/* ========= Config ========= */
const BASE_PDF_URL='./assets/Buyer Agreement to Show Property.pdf';
const CMAP_URL='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/cmaps/';
const FONT_URL='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/standard_fonts/';
const $=s=>document.querySelector(s);

/* ========= Stepper Nav ========= */
let currentStep=1;
function setStep(n){
  currentStep=n;
  ['#step1','#step2','#step3'].forEach((sel,i)=>{
    $(sel).classList.toggle('active', i===n-1);
  });
  $('#crumb').textContent=`Step ${n} of 3`;
  [$('#dot1'),$('#dot2'),$('#dot3')].forEach((d,i)=>{
    d.classList.toggle('active', i===n-1);
    d.classList.toggle('done', i<n-1);
  });
}

/* ========= Dates ========= */
function setupDateFields(){
  const today=new Date();
  const fmt=d=>[(d.getMonth()+1+'').padStart(2,'0'),(d.getDate()+'').padStart(2,'0'),d.getFullYear()].join('/');
  const start=fmt(today);
  const exp=new Date(today); exp.setMonth(exp.getMonth()+2);
  const end=fmt(exp);
  $('#hiddenStartDate').value=start;
  $('#hiddenExpirationDate').value=end;
}

/* ========= Signature Pad ========= */
function initSignaturePad(){
  const canvas=$('#signature-pad');
  const ctx=canvas.getContext('2d');
  let drawing=false;

  function size(){
    const w=canvas.clientWidth||canvas.parentElement.clientWidth;
    const h=200; canvas.width=w; canvas.height=h;
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
  }
  size(); addEventListener('resize',size);

  const pos=e=>{const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top};};
  const start=e=>{drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y);};
  const move=e=>{if(!drawing) return; const p=pos(e); ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; ctx.lineTo(p.x,p.y); ctx.stroke();};
  const end=()=>{drawing=false;};

  canvas.addEventListener('mousedown',start); canvas.addEventListener('mousemove',move);
  canvas.addEventListener('mouseup',end); canvas.addEventListener('mouseleave',end);
  canvas.addEventListener('touchstart',e=>{e.preventDefault();start(e)},{passive:false});
  canvas.addEventListener('touchmove',e=>{e.preventDefault();move(e)},{passive:false});
  canvas.addEventListener('touchend',e=>{e.preventDefault();end(e)},{passive:false});

  $('#clear-signature').onclick=()=>{ size(); $('#signature-data').value=''; };
  $('#accept-signature').onclick=()=>{
    $('#signature-data').value=canvas.toDataURL();
    const b=$('#accept-signature'), t=b.innerHTML; b.innerHTML='<i class="fa-solid fa-check"></i> Accepted'; b.style.background='#0ea5e9';
    setTimeout(()=>{b.innerHTML=t; b.style.background='var(--ok)';},1100);

// 👇 Scroll to the bottom so the Submit button/thank-you are visible
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  };
}

/* ========= Build Signed PDF ========= */
async function generateCompletedPDF(){
  const res=await fetch(BASE_PDF_URL); if(!res.ok) throw new Error('Could not load base PDF');
  const baseBytes=await res.arrayBuffer();
  const doc=await PDFLib.PDFDocument.load(baseBytes);
  const form=doc.getForm?.();

  const fullName=$('#fullName').value||'';
  const startDate=$('#hiddenStartDate').value||'';
  const expirationDate=$('#hiddenExpirationDate').value||'';
  const signatureData=$('#signature-data').value||'';

  try{form?.getTextField('Name').setText(fullName);}catch{}
  try{form?.getTextField('StartDate').setText(startDate);}catch{}
  try{form?.getTextField('EndDate').setText(expirationDate);}catch{}
  try{form?.getTextField('SigDate').setText(startDate);}catch{}
  try{form?.getCheckBox('Residential').check();}catch{}

  // Signature image on last page (coords tuned; adjust if your form differs)
  if(signatureData){
    try{
      const png=await doc.embedPng(signatureData);
      const pages=doc.getPages(); const last=pages[pages.length-1];
      const {width,height}=last.getSize();
      const sigW=width*0.22, sigH=height*0.045;
      const x=width*0.12, y=height*0.28;
      last.drawImage(png,{x,y,width:sigW,height:sigH});
    }catch{}
  }
  return await doc.save({updateFieldAppearances:true});
}


/* ========= Digital Reader (Plain, mobile-friendly text with live dates) ========= */
async function buildDigitalReader(){
  const wrap = document.querySelector('#digital-view');
  wrap.setAttribute('aria-busy','true');

  // ✅ Generate real Start and Expiration dates
  const today = new Date();
  const fmt = d => [(d.getMonth()+1).toString().padStart(2,'0'), d.getDate().toString().padStart(2,'0'), d.getFullYear()].join('/');
  const startDate = fmt(today);
  const exp = new Date(today);
  exp.setDate(today.getDate() + 7);
  const expirationDate = fmt(exp);

  // ✅ Build the digital readable version with actual date strings
  wrap.innerHTML = `
    <section class="page">
      <div class="chip">Digital View</div>

      <h3>Notice to Buyer</h3>
      <p>All REALTORS® are required to have a signed written agreement prior to showing a home. This Buyer-Broker Agreement to Show Property authorizes your broker to show you property and provide other real estate services at your discretion, which may include negotiation and advocacy throughout a transaction.</p>

      <h3>Term</h3>
      <p>This Agreement begins on <strong>${startDate}</strong> and expires at <strong>11:59 p.m.</strong> on <strong>${expirationDate}</strong>.</p>

      <h3>Property</h3>
      <p>Your broker will locate and show property that fits your criteria. Typical categories include Residential, Land, Commercial, or Other.</p>

      <h3>Agency</h3>
      <p>The agency relationship between Broker and Buyer determines how your broker will work on your behalf and will be documented in the Real Estate Agency Disclosure and Election form.</p>

      <h3>Broker Compensation</h3>
      <p><em>Broker compensation is not set by law, any board, association of REALTORS®, or MLS. It is fully negotiated between Broker and Buyer in this Agreement.</em></p>
      <p>If Broker represents Buyer in the purchase of a property (as indicated on a purchase contract signed prior to the Expiration Date), Buyer agrees to compensate Broker as one of the following:</p>
      <ul>
        <li><strong>$1.00</strong> (the “$1 Promise” if seller-paid compensation cannot be negotiated); or</li>
      </ul>
      <p>Broker Compensation is due and paid at close of escrow. Buyer authorizes Broker to accept compensation from the seller or seller’s broker, which will be credited against the agreed Broker Compensation. Broker will not receive any amount greater than the Broker Compensation for services under this Agreement.</p>

      <h3>Buyer Showing Instructions</h3>
      <p>Broker will show property listings that fit your criteria regardless of the compensation offered by the seller or seller’s broker, unless you instruct otherwise in writing. If necessary, you instruct Broker to attempt to negotiate for the seller or seller’s broker to pay the Broker Compensation. Any such negotiations will not jeopardize, delay, or interfere with the initiation, processing, or finalization of a transaction.</p>

      <h3>Equal Housing Opportunity</h3>
      <p>Broker abides by all local, state, and federal fair housing laws prohibiting discrimination. For more information, see the Fair Housing Advisory.</p>

      <h3>Acceptance</h3>
      <p>By signing, Buyer agrees to all terms and acknowledges receipt of a copy of this Agreement.</p>

      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:12px 0">
      <p class="muted">This digital view is provided for convenience and readability. The <strong>signed PDF</strong> generated in Step 3 remains the official record that is emailed to your broker and saved for your receipt.</p>
    </section>
  `;

  // ✅ Unlock checkbox once scrolled to bottom
  const scrollBox = wrap;
  const confirm = document.querySelector('#confirm-read');
  const next = document.querySelector('#next2');

  const checkBottom = () => {
    const nearBottom = scrollBox.scrollTop + scrollBox.clientHeight >= scrollBox.scrollHeight - 20;
    if (nearBottom) confirm.disabled = false;
    next.disabled = !(confirm.checked && !confirm.disabled);
  };

  scrollBox.addEventListener('scroll', checkBottom, { passive: true });
  document.querySelector('#jumpBottom').onclick = () => {
    scrollBox.scrollTop = scrollBox.scrollHeight;
    confirm.disabled = false;
    checkBottom();
  };
  confirm.addEventListener('change', checkBottom);

  checkBottom();
  wrap.removeAttribute('aria-busy');
}




/* ========= Submit Handling ========= */
function lockFormUI(form){
  [...form.elements].forEach(el=>{ if(el.tagName!=='BUTTON'){ el.disabled=true; el.readOnly=true; }});
}
function startRedirectCountdown(){
  let sec=10; const el=$('#countdown'); if(!el) return; el.textContent=sec;
  const t=setInterval(()=>{sec--; el.textContent=sec; if(sec<=0){clearInterval(t); location.href='index.html';}},1000);
}

/* ========= Init ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  // Step buttons
  $('#next1').onclick=()=>{ setStep(2); };
  $('#back2').onclick=()=>{ setStep(1); };
  $('#next2').onclick=()=>{ if(!$('#next2').disabled) setStep(3); };
  $('#back3').onclick=()=>{ setStep(2); };

  // Reader + fields + signature
  buildDigitalReader();
  setupDateFields();
  initSignaturePad();

  // Enable Continue in step 2 only when checkbox checked
  $('#confirm-read').addEventListener('change',()=>{
    $('#next2').disabled = !$('#confirm-read').checked;
  });

  // Submit
  const form=$('#agreement-form');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const missing=[];
    if(!$('#fullName').value.trim()) missing.push('• Enter your full name');
    if(!$('#initials').value.trim()) missing.push('• Enter your initials');
    if(!$('#confirm-read').checked) missing.push('• Confirm you read the agreement');
    const sig=$('#signature-data').value;
    if(!sig || sig.length<900) missing.push('• Add your signature (tap Accept)');
    if(missing.length){ alert('Please complete:\n'+missing.join('\n')); return; }

    const submitBtn=$('#submit-btn');
    submitBtn.disabled=true; submitBtn.textContent='Submitting…';

    try{
      // Build signed PDF (same as before)
      const pdfBytes=await generateCompletedPDF();
      const blob=new Blob([pdfBytes],{type:'application/pdf'});
      const safeName=($('#fullName').value||'Client').replace(/\s+/g,'_');
      const file=new File([blob],`BuyerBrokerAgreement_${safeName}.pdf`,{type:'application/pdf'});

      // Post to FormSubmit with file attachment
      const fd=new FormData();
      ['fullName','initials'].forEach(id=>{ const el=$('#'+id); if(el) fd.append(el.name, el.value); });
      fd.append('startDate',$('#hiddenStartDate').value);
      fd.append('expirationDate',$('#hiddenExpirationDate').value);
      fd.append('confirmRead',$('#confirm-read').checked ? 'true':'false');
      fd.append('_subject','New Buyer Broker Agreement');
      fd.append('_captcha','false');
      fd.append('_template','table');
      fd.append('_next','thank-you.html');
      fd.append('agreement_pdf', file);

      const res=await fetch(form.action,{method:'POST', body:fd});
      if(!res.ok && res.status!==0) throw new Error('Form submission failed');

      // Download a copy for the buyer
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=file.name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);

      // Lock + thank you
// Lock UI + show thank you + redirect to next stage
lockFormUI(form);
const ty = $('#thank-you');
ty.style.display = 'block';
ty.innerHTML = `
  <h3><i class="fa-solid fa-circle-check"></i> Thank you!</h3>
  <p>Your signed agreement has been sent successfully.</p>
  <p><strong>Sending you to the next stage…</strong></p>
`;
submitBtn.style.display = 'none';

// Smooth scroll to show the message
window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });

// Redirect to your next step
setTimeout(()=>{
  window.location.href = 'https://bettercallparker.github.io/steps/search.html';
}, 4000);

    }catch(err){
      console.error(err);
      alert('There was a problem sending your signed agreement. Please try again.');
      submitBtn.disabled=false; submitBtn.textContent='Submit Signed Agreement';
    }
  });
});
</script>
</body>
</html>
